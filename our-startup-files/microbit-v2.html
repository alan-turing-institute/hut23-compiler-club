<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-09-01 Sun 13:44 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Our BBC micro:bit v2 linker script</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="The Hut23 Compiler Club" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Our BBC micro:bit v2 linker script</h1>
<p>
:header-args: :noweb no-export :exports code :padline yes
</p>

<div id="outline-container-org9979091" class="outline-2">
<h2 id="org9979091">How to create the linker script</h2>
<div class="outline-text-2" id="text-org9979091">
<p>
This file explains and is also the source of the linker script we have
developed for the micro:bit version 2, at least as far as we have
developed it, which is currently not very far.
</p>

<p>
To extract (or “tangle,” in literate-programming parlance) the script
itself, run <code>make</code> in this directory. That probably won't work on your
machine, but it's a start &#x2026;
</p>
</div>
</div>


<div id="outline-container-org77f80ad" class="outline-2">
<h2 id="org77f80ad">Overview</h2>
<div class="outline-text-2" id="text-org77f80ad">
<p>
The input to the linker (eg, GNU <code>ld</code>) is a set of files, known as
<i>object files</i>, containing code (in binary format) and data. The job
of the linker is to combine all the code and data in the input files
into a single output file, also known as an object file, that can be
loaded into a particular region of memory (or, in our case, flashed
onto the micro:bit).
</p>

<p>
However, when input object files are generated, for example by a C
compiler or an assembler, their final location in memory is not
known. Thus the files contain, not hard-coded memory locations, but
<i>symbols</i>: stand-ins for the final location of code or data. Each
symbol is defined in one of the input files to point to a particular
part of the data, or code, in that input file. The linker must decide
what final location each symbol refers to and arrange for all the
references to that symbol, in whatever file the reference occurs, to
refer to that location.
</p>

<p>
The linker script is a configuration file read by the linker (use the
option “​<code>-T microbit-v2.ld</code>​”). The purpose of the linker script is:
</p>

<ol class="org-ol">
<li>To describe the memory layout of the micro:bit;</li>
<li>To arrange for the various “sections” of code and data to end up in
the correct places in memory in the output object file.</li>
<li>To name particular locations in memory that can only be decided at
link time but which are referenced by the code.</li>
</ol>

<p>
Here is the overall structure of our script:
</p>

<div class="org-src-container">
<pre class="src src-ld-script" id="org55e0e0b">/* 
BBC micro:bit v2 linker script
Written by the Hut23 Compiler Club
Do not edit this file directly; instead edit the source ".org" file 
*/

&lt;&lt;1. Memory layout&gt;&gt;
&lt;&lt;2. Input and output sections&gt;&gt;
&lt;&lt;3. Entry point&gt;&gt;
</pre>
</div>

<p>
Each part is expanded below.
</p>
</div>
</div>


<div id="outline-container-org5d3f8d9" class="outline-2">
<h2 id="org5d3f8d9">Explanation of each part</h2>
<div class="outline-text-2" id="text-org5d3f8d9">
</div>
<div id="outline-container-org0b20d84" class="outline-3">
<h3 id="org0b20d84">1. Memory layout</h3>
<div class="outline-text-3" id="text-org0b20d84">
<p>
The Cortex M4 is a 32-bit CPU, meaning that it can in principle
address \(2^{32}\) bytes&#x2014;or 4 GiB&#x2014;of memory. However, the nRF52833
physically has only 512 kiB of flash memory and 128 kiB of RAM (see
section 4.2.3, figure 3, of the nRF52833 product specification). The
mapping of that physical memory into the 4 GiB of “virtual” memory
space is described by the first part of the linker script.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Memory layout of the Nordic nRF528333</label><pre class="src src-ld-script" id="org5d9139d">MEMORY {
  FLASH    (rx) : ORIGIN = 0x00000000, LENGTH = 512K  
  RAM      (wx) : ORIGIN = 0x20000000, LENGTH = 128K
  CODE_RAM (wx) : ORIGIN = 0x00800000, LENGTH = 128K 
}
</pre>
</div>

<p>
(By the way, every linker file I've seen writes the attributes of the
RAM section as <code>rwx</code> rather than (as here) just <code>wx</code>. However, the GNU
<code>ld</code> manual (section 3.8) clearly says that the attribute <code>w</code> means
read <i>and</i> write.)
</p>

<p>
On this device the 128 kiB of physical RAM is mapped <i>both</i> to the
normal location (labelled as <code>RAM</code>) and <i>also</i> to an area of memory
just above the flash memory. This <code>CODE_RAM</code> is the same physical RAM,
just accessible from two different places in “memory.” The reason
seems to be that the CPU accesses this memory on a different bus and
that this can be faster if one is executing code. However, the rest of
this linker script ignores the code RAM.
</p>

<p>
There are other bits of memory&#x2014;for example, the memory-mapped
peripheral registers, and some non-volatile configuration memory
regions&#x2014;but I am unsure whether we should write that down here or
not. That does not seem to be the done thing but I am not entirely
sure why not.
</p>
</div>
</div>

<div id="outline-container-org9cc80a7" class="outline-3">
<h3 id="org9cc80a7">2. Input and output sections</h3>
<div class="outline-text-3" id="text-org9cc80a7">
<p>
The content of the linker’s input files and output file are assigned
to regions called “sections.” One job of the linker is to map the
sections in the input files to the sections in the output file and to
write in the output file where the output sections are to end up in
memory.
</p>

<p>
There are four conventional input sections produced, for example, by
the C compiler, which will be the input sections to the linker. (There
may be others but these seem to be the critical ones.) They are:
</p>

<dl class="org-dl">
<dt><code>.text</code></dt><dd>which holds code;</dd>
<dt><code>.rodata</code></dt><dd>wihch holds data that will never be modified by the
program.</dd>
<dt><code>.data</code></dt><dd>which holds “initialised data,” that is, data that starts
with a given value; and</dd>
<dt><code>.bss</code></dt><dd>which holds “uninitialised data,” that is, data that is
supposed to start off as zero.</dd>
</dl>

<p>
No-one remembers what “BSS” stands for. Some people read it as “better
save space.” In some sense the <code>.bss</code> section is unnecessary: data in
this section is supposed to be initialised to zero before the program
begins so it could have been placed in the <code>.data</code> section. However,
the output file can be made smaller by not storing the actual zeros
but instead merely noting how much space they will need. When the
program starts, one of its first jobs will be to zero the memory
locations (and we will have to write code to do this). In addition,
the data in the <code>.data</code> section will need to be copied into RAM
(and we will need to write code to do this, as well).
</p>

<p>
There is one other input section, <code>.vectors</code>, which is not populated
by the C compiler but by a small piece of startup code (which we need
to write). It holds the “interrupt vector table,” a list of pointers
to code that is to be called by the hardware when various hardware
events happen. (I think this is “vector” in the sense of “pointer to
something,” rather than the sense of “one-dimensional array:” it is a
table of interrupt-vectors, not a vector of interrupts.) The way the
CPU gets started, after a reset, is first to load the stack pointer
with the address found in the four bytes at the beginning of the
interrupt vector table, and then to jump to the address in the
following four bytes.
</p>

<p>
All of these input sections will be grouped by this linker script into
three output sections: <code>.text</code>, <code>.data</code>, and <code>.bss</code> (although I'm not
actually sure the output names matter). The contents of the <code>.text</code>
section will end up in flash memory and the contents of the <code>.data</code>
and <code>.bss</code> sections will (eventually) end up in RAM. <sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<p>
If the input files contain other sections not specified in this script
(called “orphaned sections” by the GNU <code>ld</code> reference) then my
understanding is that they will be placed in the output file
<i>somewhere</i> by the linker anyway. <sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Output sections</label><pre class="src src-ld-script" id="orgd297068">SECTIONS {
  &lt;&lt;2.1 text output section&gt;&gt;
  &lt;&lt;2.2 data output section&gt;&gt;
  &lt;&lt;2.3 bss output section&gt;&gt;
}
</pre>
</div>
</div>

<div id="outline-container-org806d74f" class="outline-4">
<h4 id="org806d74f">2.1 Text output section</h4>
<div class="outline-text-4" id="text-org806d74f">
<p>
The <code>.text</code> output section gathers together all the parts of the input
that will end up in flash memory.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Text output section</label><pre class="src src-ld-script" id="org38ab652">.text : {
  KEEP(*(.vectors))
  *(.text*)
  *(.rodata*)
} &gt;FLASH
</pre>
</div>

<p>
Each line of this part of the script specifies a set of input
sections; namely, those matching the pattern in the line. For example,
the pattern matches all input files (that's
the first asterisk) and, within those, all sections whose name begin
with `' (that's the second asterisk). <sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>
</p>

<p>
The interrupt vectors section is wrapped in “”
because, as I understand it, the linker may choose to omit (or
“garbage collect”) sections that don't appear to be referenced by the
main sections.
</p>
</div>
</div>

<div id="outline-container-orgd429111" class="outline-4">
<h4 id="orgd429111">2.2 Data output section</h4>
<div class="outline-text-4" id="text-orgd429111">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Data output section</label><pre class="src src-ld-script" id="orgd9efb5a">.data : ALIGN(4) {
  __data_start = .;
  *(.data)
  *(.data.*)
} &gt;RAM AT &gt;FLASH
__data_end = __data_start + SIZEOF(.data);  
</pre>
</div>

<p>
The data section is tricky. It needs to say something like, “these
input sections should be loaded into flash memory but <i>look</i> as if it
they are present in RAM, in the sense that, whenever any of the
addresses in these sections are referenced, those references should
point to the section in <code>RAM</code>.” That's what “” does. <sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup>
</p>

<p>
I'm not sure why the two data lines aren't a single line,
, but this is what the Arm example linker
script does so I have copied it.
</p>

<p>
Finally, this section begins with an alignment command: in this case,
that the section should start on a memory address divisible by
four. Obviously it will, because it will start at the origin of RAM,
which is divisible by four; but, again, the practice of putting in an
seems to be the norm. 
</p>
</div>
</div>

<div id="outline-container-orgdf0c385" class="outline-4">
<h4 id="orgdf0c385">2.3 BSS output section</h4>
<div class="outline-text-4" id="text-orgdf0c385">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>BSS output section</label><pre class="src src-ld-script" id="orgc1c3cfd">.bss : ALIGN(4) {
  __bss_start = .;
  *(.bss)
  *(.bss.*);
  . = ALIGN(4);
} &gt;RAM
__bss_end = __bss_start + SIZEOF(.bss);
</pre>
</div>

<p>
The output section merely reserves space (in RAM)
for the uninitialised data section. (Which I feel is something of a
misnomer, since it <i>will</i> be initialised, just to zero.)
</p>
</div>
</div>
</div>

<div id="outline-container-org74cca05" class="outline-3">
<h3 id="org74cca05">3. Entry point</h3>
</div>
</div>


<div id="outline-container-org434c6e4" class="outline-2">
<h2 id="org434c6e4">What is missing?</h2>
<div class="outline-text-2" id="text-org434c6e4">
<ol class="org-ol">
<li>Exported symboles.</li>
</ol>
</div>
</div>


<div id="outline-container-org7df193b" class="outline-2">
<h2 id="org7df193b">Sources</h2>
<div class="outline-text-2" id="text-org7df193b">
<ul class="org-ul">
<li>I have taken the memory layout from the nRF52833 product
specification.</li>

<li>I have referred to both the Arm and Nordic Semiconductor example
linker scripts (and startup files).</li>

<li>The <a href="https://sourceware.org/binutils/docs/ld/index.html">GNU <code>ld</code> manual</a> explains the meanings of the various parts of
the linker script.</li>
</ul>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
The example linker script provided by Nordic Semiconductor
breaks out more of the input sections into their own output
sections. I don't know why one chooses one approach over another.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
We should probably run <code>ld</code> with <code>--orphan-handling=warn</code>.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
GCC emits multiple text sections when the option
<code>-ffunction-sections</code> is used.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
The terminology is as follows. The address of this section at run-time
is called the “virtual memory address” [VMA], whereas the address at
which the section is loaded into memory is called the “load memory
address” [LMA].
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: The Hut23 Compiler Club</p>
<p class="date">Created: 2024-09-01 Sun 13:44</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
